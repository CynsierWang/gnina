BOOST_INCLUDE = $(BASE)/include/boost
CUDA_INCLUDE = $(BASE)/cuda/include
LIBOBJ = atom_constants.o box.o builtinscoring.o cache.o coords.o  custom_terms.o everything.o flexinfo.o grid.o gpucode.o  szv_grid.o model.o monte_carlo.o mutate.o my_pid.o naive_non_cache.o non_cache.o obmolopener.o parallel_mc.o parse_pdbqt.o pdb.o quasi_newton.o quaternion.o random.o ssd.o terms.o weighted_terms.o molgetter.o result_info.o PDBQTUtilities.o GninaConverter.o precalculate_gpu.o non_cache_gpu.o
MAINOBJ = main.o
TOGNINAOBJ = tognina.o CommandLine.o 
FROMGNINAOBJ = fromgnina.o CommandLine.o 
GNINAGRIDOBJ = gninagrid.o nngridder.o
SERVEROBJ = server.o CommandLine.o MinimizationQuery.o QueryManager.o
CFLAGS += -Wno-deprecated-declarations
INCFLAGS = -I $(BOOST_INCLUDE) -I $(OPENBABEL_INCLUDE) -I $(CUDA_INCLUDE) 
NVCC=$(BASE)/cuda/bin/nvcc

# TODO: sucks
CC = $(NVCC) $(NVOPTS) -x cu --expt-relaxed-constexpr -gencode arch=compute_52,code=sm_52 --compiler-options="-std=c++11 $(C_PLATFORM) $(C_OPTIONS) $(CFLAGS)" $(INCFLAGS)

LDFLAGS := -L$(BASE)/lib -L. -L/usr/local/lib -L$(BASE)/cuda/lib64 $(LDFLAGS)

LIBS = -l openbabel -l boost_iostreams${BOOST_LIB_VERSION} -l boost_timer${BOOST_LIB_VERSION} -lz -l boost_system${BOOST_LIB_VERSION} -l boost_regex${BOOST_LIB_VERSION} -l boost_thread${BOOST_LIB_VERSION} -l boost_serialization${BOOST_LIB_VERSION} -l boost_filesystem${BOOST_LIB_VERSION} -l boost_program_options${BOOST_LIB_VERSION} -l boost_date_time${BOOST_LIB_VERSION} -lcudart

.SUFFIXES: .cpp .o

%.o : ../../../src/*/%.cpp 
	$(CC) -I ../../../src/lib -o $@ -dc $< 

%.o : ../../../src/lib/CommandLine2/%.cpp 
	$(CC) -I ../../../src/lib -o $@ -dc $< 

%.o : ../../../src/lib/%.cu ../../../src/lib/*gpu.h
	$(NVCC) $(NVOPTS) -DSMINA_GPU -o $@ -dc $< 

all: gnina tognina gninaserver libgnina.a gninagrid

include dependencies

gnina: $(MAINOBJ) $(LIBOBJ)
	$(CC) $(LDFLAGS) -o $@ $^ $(LIBS)
	@echo "Done"

tognina: $(TOGNINAOBJ) $(LIBOBJ)
	$(CC) $(LDFLAGS) -o $@ $^ $(LIBS)
	@echo "Done"

fromgnina: $(FROMGNINAOBJ) $(LIBOBJ)
	$(CC) $(LDFLAGS) -o $@ $^ $(LIBS)
	@echo "Done"	

gninagrid: $(GNINAGRIDOBJ) $(LIBOBJ)
	$(CC) $(LDFLAGS) -o $@ $^ $(LIBS)
	@echo "Done"    	

gninaserver: $(SERVEROBJ) $(LIBOBJ)
	$(CC) $(LDFLAGS) -o $@ $^ $(LIBS)
	@echo "Done"	

libgnina.a: $(LIBOBJ)
	 ar rcs libgnina.a $^

clean:
	rm -f *.o

depend:
	rm -f dependencies_tmp dependencies_tmp.bak
	touch dependencies_tmp
	makedepend -f dependencies_tmp -Y -I ../../../src/lib ../../../src/lib/*.cpp   ../../../src/main/*.cpp ../../../src/gninaserver/*.cpp  ../../../src/tognina/*.cpp ../../../src/gninagrid/*.cpp
	sed -e "s/^\.\.\/\.\.\/\.\.\/src\/[a-z]*\//.\//" dependencies_tmp > dependencies
	rm -f dependencies_tmp dependencies_tmp.bak
